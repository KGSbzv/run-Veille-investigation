# Ce pipeline Cloud Build est conçu pour être déclenché par des commits sur un dépôt (ex: GitHub, Cloud Source Repositories).
#
# Prérequis :
# 1. Activer les APIs Cloud Build, Cloud Run, et Container Registry sur votre projet GCP.
# 2. Donner le rôle "Administrateur Cloud Run" et "Administrateur de l'espace de stockage" au compte de service Cloud Build.
#    (Projet GCP -> IAM -> Chercher le compte de service se terminant par @cloudbuild.gserviceaccount.com)
#
steps:
# 1. Construire l'image Docker de l'application frontend.
# Le tag utilise des substitutions automatiques de Cloud Build ($PROJECT_ID, $BUILD_ID).
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'gcr.io/$PROJECT_ID/${_SERVICE_NAME}:$BUILD_ID', '-t', 'gcr.io/$PROJECT_ID/${_SERVICE_NAME}:latest', '.']
  id: 'Build'

# 2. Pousser l'image construite vers Google Container Registry (GCR).
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'gcr.io/$PROJECT_ID/${_SERVICE_NAME}:$BUILD_ID']
  id: 'Push'

# 3. Déployer la nouvelle image sur Google Cloud Run.
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  entrypoint: gcloud
  args:
    - 'run'
    - 'deploy'
    - '${_SERVICE_NAME}'
    - '--image=gcr.io/$PROJECT_ID/${_SERVICE_NAME}:$BUILD_ID'
    - '--region=${_REGION}'
    - '--platform=managed'
    - '--allow-unauthenticated'
    - '--port=8080'
    - '--memory=512Mi'
    - '--cpu=1'
    - '--max-instances=10'
    - '--set-env-vars=NODE_ENV=production'
  id: 'Deploy'

# Liste des images à conserver après le build.
images:
- 'gcr.io/$PROJECT_ID/${_SERVICE_NAME}:$BUILD_ID'
- 'gcr.io/$PROJECT_ID/${_SERVICE_NAME}:latest'

# Variables de substitution personnalisables.
substitutions:
  _SERVICE_NAME: 'cacrs-frontend'
  _REGION: 'europe-west1'

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'N1_HIGHCPU_8'